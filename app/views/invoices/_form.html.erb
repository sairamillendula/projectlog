<%= nested_form_for(@invoice) do |f| %>
  <% if @invoice.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@invoice.errors.count, "error") %> prohibited this invoice from being saved:</h2>

      <ul>
        <% @invoice.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="inline-form">
    <div class="field">
      <%= f.label :invoice_number, "Number", :class => 'mandatory' %>
      <%= f.text_field :invoice_number %>
    </div>
    <div class="field">
      <%= f.label :subject, :class => 'mandatory' %>
      <%= f.text_field :subject, :style => "width:650px;" %>
    </div>
    <div class="field">
      <%= f.label :issued_date, :class => 'mandatory' %>
      <%= f.text_field :issued_date %>
    </div>
    <div class="field">
      <%= f.label :customer_id, :class => 'mandatory' %>
      <%= f.select :customer_id, current_user.customers.collect { |c| [c.name, c.id] } %>
    </div>
    <div class="field">
      <%= f.label :status, :class => 'mandatory' %>
      <%= f.select :status, options_for_select(Invoice.status_list, @invoice.status) %>
    </div>
    <div class="field">
      <%= f.label :due_date %>
      <%= f.text_field :due_date %>
    </div>
    <div class="field">
      <%= f.label :currency %>
      <%= f.select :currency, options_for_select(currency_options, @invoice.currency) %>
    </div>
    <div class="field">
      <%= f.label :balance, :class => 'mandatory' %>
      <%= f.text_field :balance %>
    </div>
  </div>
  <br/>
  <div class="full-width table" id="line-items">
    <div class="tr">
      <div class="th">Type</div>
      <div class="th">Description</div>
      <div class="th">Quantity</div>
      <div class="th">Price</div>
      <% if @invoice.user.profile.any_taxes? %>
        <div class="th">Subtotal</div>
        <div class="th">Taxes</div>
        <% unless @invoice.user.profile.tax1.blank? %>
          <div class="th tax1 hidden" data-taxvalue="<%= @invoice.user.profile.tax1 %>"><%= @invoice.user.profile.tax1_name %></div>
        <% end %>
        <% unless @invoice.user.profile.tax2.blank? %>
          <div class="th tax2 hidden" data-taxvalue="<%= @invoice.user.profile.tax2 %>" data-taxcompound="<%= @invoice.user.profile.compound %>"><%= @invoice.user.profile.tax2_name %></div>
        <% end %>
      <% end %>
      <div class="th">Amount</div>
    </div>
    <%= f.fields_for :line_items %>
    <span id="add_new_invoice_line"><%= f.link_to_add "Add new line", :line_items %></span>
  </div>
  <div class="separation"></div>
  <table style="width:100%" id="total">
    <tr>
      <td colspan=6>Subtotal: </td>
      <td id="subtotal"><%= @invoice.line_items.collect(&:line_total).sum.round(2) %></td>
    </tr>
    <tr>
      <td colspan=6>Taxes: </td>
      <td id="taxtotal"><%= @invoice.line_items.collect { |i| (i.tax1 || 0) + (i.tax2 || 0) }.sum.round(2) %></td>
    </tr>
    <tr>
      <td colspan=6><%= f.label :discount, 'Discount % ' %></td>
      <td ><%= f.number_field :discount %></td>
    </tr>
    <tr>
      <td colspan=6>Amount Due: </td>
      <td id="amount_due" style="width: 1%"><%= (@invoice.line_items.collect(&:line_total).sum*(1-(@invoice.discount || 0)/100)).round(2) %></td>
    </tr>
  </table>
  <%= f.label :note %><br />
  <%= f.text_area :note %>

  <div class="actions">
    <%= submit_or_cancel(f) %>
  </div>
<% end %>
